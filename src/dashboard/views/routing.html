<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Robin MCP â€” Source Routing</title>
<!-- IBM Plex Sans -->
<link rel="stylesheet" href="https://1.www.s81c.com/common/carbon/plex/sans.css">
<!-- Carbon Themes (g100 dark) -->
<link rel="stylesheet" href="https://1.www.s81c.com/common/carbon/web-components/tag/latest/themes.css">
<!-- Shared styles -->
<link rel="stylesheet" href="/dashboard/assets/shared.css">
<!-- Carbon Web Components -->
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/tile.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/tag.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/tabs.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/button.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/accordion.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/structured-list.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/modal.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/text-input.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/select.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/textarea.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/tag/v2/latest/notification.min.js"></script>
<style>
  body {
    background: var(--cds-background, #161616);
  }
  /* Structured list row layout */
  .rule-cells {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    flex-wrap: wrap;
  }
  .rule-source {
    font-weight: 600;
    font-size: 0.9rem;
    min-width: 140px;
    color: var(--cds-text-primary, #f4f4f4);
  }
  .rule-reason {
    flex: 1;
    font-size: 0.82rem;
    color: var(--cds-text-secondary, #c6c6c6);
    min-width: 200px;
  }
  /* Modal form spacing */
  cds-modal .modal-form-group {
    margin-bottom: 1rem;
  }
  cds-modal cds-text-input,
  cds-modal cds-select,
  cds-modal cds-textarea {
    width: 100%;
  }
</style>
</head>
<body class="cds-theme-zone-g100">
<div class="page-container">

  <!-- Header -->
  <div class="dashboard-header">
    <h1>Source Routing Rules</h1>
    <div class="header-controls">
      <cds-tabs type="contained" value="routing" id="navTabs">
        <cds-tab value="overview">Overview</cds-tab>
        <cds-tab value="routing" selected>Routing</cds-tab>
      </cds-tabs>
    </div>
  </div>

  <!-- Read-only notice -->
  <div id="readonlyNotice" style="display:none;margin-bottom:1rem">
    <cds-inline-notification
      kind="warning"
      title="Read-only access"
      subtitle="Editing is disabled for this token."
      low-contrast
      hide-close-button
    ></cds-inline-notification>
  </div>

  <!-- Preview Routing -->
  <div class="preview-section">
    <cds-tile>
      <h2 class="section-title">Preview Routing</h2>
      <div class="preview-input-row">
        <cds-text-input
          id="previewContext"
          placeholder="Enter context (e.g. creative-writing, code, research)"
          label="Context"
          hide-label
          size="sm"
        ></cds-text-input>
        <cds-button size="sm" id="previewBtn">Preview</cds-button>
      </div>
      <div id="previewResult" class="preview-result"></div>
    </cds-tile>
  </div>

  <!-- Rules by context (accordion) -->
  <div class="rules-container" id="rulesContainer"></div>

  <!-- Add new context button -->
  <div id="newContextBtn" style="margin-top:0.75rem;display:none">
    <cds-button kind="primary" id="addContextBtn">+ New Context Rule</cds-button>
  </div>

  <!-- Unrouted sources -->
  <div id="unroutedSection" style="display:none;margin-top:2rem">
    <cds-tile>
      <h2 class="section-title" style="color:var(--cds-text-secondary,#c6c6c6)">Unrouted Sources</h2>
      <p style="font-size:0.82rem;color:var(--cds-text-helper,#8d8d8d);margin-bottom:0.75rem">
        These sources are connected but not assigned to any routing context.
      </p>
      <div id="unroutedList"></div>
    </cds-tile>
  </div>

</div>

<!-- Edit/Add Modal -->
<cds-modal id="modal" size="sm">
  <cds-modal-header>
    <cds-modal-close-button></cds-modal-close-button>
    <cds-modal-heading id="modalTitle">Edit Rule</cds-modal-heading>
  </cds-modal-header>
  <cds-modal-body>
    <div class="modal-form-group">
      <cds-text-input
        id="modalContext"
        label="Context"
        placeholder="e.g. code, research"
      ></cds-text-input>
    </div>
    <div class="modal-form-group">
      <cds-select id="modalSource" label="Source">
      </cds-select>
    </div>
    <div class="modal-form-group">
      <cds-textarea
        id="modalReason"
        label="Reason"
        placeholder="Why this source is relevant for this context"
      ></cds-textarea>
    </div>
  </cds-modal-body>
  <cds-modal-footer>
    <cds-modal-footer-button kind="secondary" id="modalCancel">Cancel</cds-modal-footer-button>
    <cds-modal-footer-button kind="primary" id="modalSave">Save</cds-modal-footer-button>
  </cds-modal-footer>
</cds-modal>

<!-- Description Edit Modal -->
<cds-modal id="descModal" size="sm">
  <cds-modal-header>
    <cds-modal-close-button></cds-modal-close-button>
    <cds-modal-heading>Edit Context Description</cds-modal-heading>
  </cds-modal-header>
  <cds-modal-body>
    <div class="modal-form-group">
      <cds-text-input id="descModalContext" label="Context" disabled></cds-text-input>
    </div>
    <div class="modal-form-group">
      <cds-textarea id="descModalText" label="Description" placeholder="What this context is for"></cds-textarea>
    </div>
  </cds-modal-body>
  <cds-modal-footer>
    <cds-modal-footer-button kind="secondary" id="descModalCancel">Cancel</cds-modal-footer-button>
    <cds-modal-footer-button kind="primary" id="descModalSave">Save</cds-modal-footer-button>
  </cds-modal-footer>
</cds-modal>

<script>
const API = '/dashboard/api';
let sources = [];
let isReadonly = false;
let currentContexts = {};
let currentDescriptions = {};

async function fetchJson(url, opts) {
  const res = await fetch(url, opts);
  if (res.status === 403) { isReadonly = true; return null; }
  if (!res.ok) throw new Error(res.statusText);
  return res.json();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function loadRules() {
  const data = await fetchJson(API + '/routing');
  if (!data) return;

  sources = data.sources || [];
  currentContexts = data.contexts || {};
  currentDescriptions = data.contextDescriptions || {};

  // Populate source dropdown
  const sel = document.getElementById('modalSource');
  sel.innerHTML = sources.map(s =>
    '<cds-select-item value="' + s.id + '">' + escHtml(s.name) + ' (' + s.id + ')</cds-select-item>'
  ).join('');

  const container = document.getElementById('rulesContainer');
  const ctxKeys = Object.keys(currentContexts).sort();

  if (ctxKeys.length === 0) {
    container.innerHTML = '<p class="empty-state">No routing rules configured.</p>';
    if (!isReadonly) {
      document.getElementById('newContextBtn').style.display = 'block';
    }
    return;
  }

  // Build accordion
  let html = '<cds-accordion>';
  ctxKeys.forEach(ctx => {
    const rules = currentContexts[ctx];
    const desc = currentDescriptions[ctx] || '';
    html += '<cds-accordion-item title="' + escHtml(ctx) + ' (' + rules.length + ')" open>';

    // Context description row
    html += '<div class="context-desc-row">';
    html += '<span class="context-desc">' + (desc ? escHtml(desc) : '<em>No description</em>') + '</span>';
    if (!isReadonly) {
      html += '<cds-button kind="ghost" size="sm" data-action="edit-desc" data-ctx="' + escHtml(ctx) + '">Edit Description</cds-button>';
    }
    html += '</div>';

    // Structured list for rules
    html += '<cds-structured-list>';
    html += '<cds-structured-list-head>' +
      '<cds-structured-list-header-row>' +
        '<cds-structured-list-header-cell>Priority</cds-structured-list-header-cell>' +
        (!isReadonly ? '<cds-structured-list-header-cell>Order</cds-structured-list-header-cell>' : '') +
        '<cds-structured-list-header-cell>Source</cds-structured-list-header-cell>' +
        '<cds-structured-list-header-cell>Reason</cds-structured-list-header-cell>' +
        (!isReadonly ? '<cds-structured-list-header-cell>Actions</cds-structured-list-header-cell>' : '') +
      '</cds-structured-list-header-row>' +
    '</cds-structured-list-head>';
    html += '<cds-structured-list-body>';

    rules.forEach((r, idx) => {
      html += '<cds-structured-list-row>' +
        '<cds-structured-list-cell><cds-tag type="blue" size="sm">' + r.priority + '</cds-tag></cds-structured-list-cell>';

      if (!isReadonly) {
        html += '<cds-structured-list-cell><div class="reorder-btns">' +
          '<cds-button kind="ghost" size="sm" data-action="move-up" data-ctx="' + escHtml(ctx) + '" data-index="' + idx + '"' + (idx === 0 ? ' disabled' : '') + '>\u2191</cds-button>' +
          '<cds-button kind="ghost" size="sm" data-action="move-down" data-ctx="' + escHtml(ctx) + '" data-index="' + idx + '"' + (idx === rules.length - 1 ? ' disabled' : '') + '>\u2193</cds-button>' +
        '</div></cds-structured-list-cell>';
      }

      html += '<cds-structured-list-cell><span class="rule-source">' + escHtml(r.source_name) + '</span></cds-structured-list-cell>' +
        '<cds-structured-list-cell><span class="rule-reason">' + escHtml(r.reason) + '</span></cds-structured-list-cell>';

      if (!isReadonly) {
        html += '<cds-structured-list-cell><div class="rule-actions">' +
          '<cds-button kind="ghost" size="sm" data-action="edit" data-ctx="' + escHtml(ctx) + '" data-source="' + escHtml(r.source_id) + '" data-reason="' + escHtml(r.reason) + '">Edit</cds-button>' +
          '<cds-button kind="danger-ghost" size="sm" data-action="delete" data-ctx="' + escHtml(ctx) + '" data-source="' + escHtml(r.source_id) + '">Delete</cds-button>' +
        '</div></cds-structured-list-cell>';
      }

      html += '</cds-structured-list-row>';
    });

    html += '</cds-structured-list-body></cds-structured-list>';

    if (!isReadonly) {
      html += '<div style="margin-top:0.5rem"><cds-button kind="primary" size="sm" data-action="add" data-ctx="' + escHtml(ctx) + '">+ Add Rule</cds-button></div>';
    }

    html += '</cds-accordion-item>';
  });
  html += '</cds-accordion>';

  container.innerHTML = html;

  if (!isReadonly) {
    document.getElementById('newContextBtn').style.display = 'block';
  }

  // Attach event listeners via delegation
  container.addEventListener('click', handleRuleAction);

  // Render unrouted sources
  const unrouted = data.unroutedSources || [];
  const unroutedSection = document.getElementById('unroutedSection');
  if (unrouted.length > 0) {
    unroutedSection.style.display = 'block';
    document.getElementById('unroutedList').innerHTML = unrouted.map(s =>
      '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0">' +
        '<cds-tag type="warm-gray" size="sm">' + escHtml(s.id) + '</cds-tag>' +
        '<span style="font-size:0.85rem;color:var(--cds-text-primary,#f4f4f4)">' + escHtml(s.name) + '</span>' +
      '</div>'
    ).join('');
  } else {
    unroutedSection.style.display = 'none';
  }
}

function handleRuleAction(e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;

  const action = btn.dataset.action;
  const ctx = btn.dataset.ctx || '';
  const sourceId = btn.dataset.source || '';
  const reason = btn.dataset.reason || '';
  const index = parseInt(btn.dataset.index, 10);

  if (action === 'edit') {
    openModal('Edit Rule', ctx, sourceId, reason);
  } else if (action === 'delete') {
    deleteRule(ctx, sourceId);
  } else if (action === 'add') {
    openModal('Add Rule', ctx, '', '');
  } else if (action === 'move-up') {
    moveRule(ctx, index, -1);
  } else if (action === 'move-down') {
    moveRule(ctx, index, 1);
  } else if (action === 'edit-desc') {
    openDescModal(ctx);
  }
}

async function moveRule(ctx, index, direction) {
  const rules = currentContexts[ctx];
  if (!rules) return;

  const newIndex = index + direction;
  if (newIndex < 0 || newIndex >= rules.length) return;

  // Build sourceIds array and swap
  const sourceIds = rules.map(r => r.source_id);
  [sourceIds[index], sourceIds[newIndex]] = [sourceIds[newIndex], sourceIds[index]];

  await fetchJson(API + '/routing/reorder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ context: ctx, sourceIds })
  });

  const scrollY = window.scrollY;
  await loadRules();
  // Wait for Carbon custom elements to render before restoring scroll
  requestAnimationFrame(() => requestAnimationFrame(() => window.scrollTo(0, scrollY)));
}

function openModal(title, ctx, sourceId, reason) {
  const modal = document.getElementById('modal');
  document.getElementById('modalTitle').textContent = title;

  const ctxInput = document.getElementById('modalContext');
  ctxInput.value = ctx;
  ctxInput.disabled = !!ctx;

  const srcSelect = document.getElementById('modalSource');
  if (sourceId) srcSelect.value = sourceId;
  else if (sources[0]) srcSelect.value = sources[0].id;

  document.getElementById('modalReason').value = reason || '';

  modal.open = true;
}

function closeModal() {
  document.getElementById('modal').open = false;
}

function openDescModal(ctx) {
  document.getElementById('descModalContext').value = ctx;
  document.getElementById('descModalText').value = currentDescriptions[ctx] || '';
  document.getElementById('descModal').open = true;
}

function closeDescModal() {
  document.getElementById('descModal').open = false;
}

async function deleteRule(ctx, sourceId) {
  if (!confirm('Delete rule: ' + ctx + ' \u2192 ' + sourceId + '?')) return;
  await fetchJson(API + '/routing', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ context: ctx, sourceId })
  });
  loadRules();
}

// Modal cancel
document.getElementById('modalCancel').addEventListener('click', closeModal);

// Also close on modal's own close event
document.getElementById('modal').addEventListener('cds-modal-closed', closeModal);

// Modal save
document.getElementById('modalSave').addEventListener('click', async () => {
  const context = (document.getElementById('modalContext').value || '').trim();
  const sourceId = document.getElementById('modalSource').value;
  const reason = (document.getElementById('modalReason').value || '').trim();

  if (!context || !sourceId || !reason) {
    alert('All fields are required.');
    return;
  }

  const result = await fetchJson(API + '/routing', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ context, sourceId, reason })
  });

  if (result === null) {
    alert('Access denied. Full access required to edit rules.');
    return;
  }

  closeModal();
  loadRules();
});

// Description modal
document.getElementById('descModalCancel').addEventListener('click', closeDescModal);
document.getElementById('descModal').addEventListener('cds-modal-closed', closeDescModal);
document.getElementById('descModalSave').addEventListener('click', async () => {
  const ctx = (document.getElementById('descModalContext').value || '').trim();
  const description = (document.getElementById('descModalText').value || '').trim();

  const result = await fetchJson(API + '/contexts/' + encodeURIComponent(ctx), {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ description })
  });

  if (result === null) {
    alert('Access denied. Full access required to edit descriptions.');
    return;
  }

  closeDescModal();
  loadRules();
});

// New context button
document.getElementById('addContextBtn').addEventListener('click', () => {
  openModal('Add Rule', '', '', '');
  document.getElementById('modalContext').disabled = false;
});

// Preview
document.getElementById('previewBtn').addEventListener('click', async () => {
  const ctxInput = document.getElementById('previewContext');
  const ctx = (ctxInput.value || '').trim();
  if (!ctx) return;

  const data = await fetchJson(API + '/routing/preview', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ context: ctx })
  });

  const container = document.getElementById('previewResult');
  if (!data || !data.rules || data.rules.length === 0) {
    container.innerHTML = '<p class="empty-state">No routing rules for this context.</p>';
    return;
  }

  const descHtml = data.description ? '<div class="context-desc" style="margin-bottom:0.5rem">' + escHtml(data.description) + '</div>' : '';

  container.innerHTML =
    descHtml +
    (data.fallback ? '<div class="preview-fallback">No specific rules \u2014 falling back to "general"</div>' : '') +
    data.rules.map(r =>
      '<div class="preview-rule">' +
        '<strong>' + r.priority + '.</strong> ' + escHtml(r.source_name) +
        ' \u2014 <span style="color:var(--cds-text-secondary,#c6c6c6)">' + escHtml(r.reason) + '</span>' +
        (r.tools ? '<br><span style="font-size:.78rem;color:var(--cds-text-helper,#8d8d8d)">Tools: ' + escHtml(r.tools) + '</span>' : '') +
      '</div>'
    ).join('');
});

// Preview on Enter key
document.getElementById('previewContext').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('previewBtn').click();
});

// Tab navigation
document.getElementById('navTabs').addEventListener('cds-tabs-selected', (e) => {
  const val = e.detail?.item?.getAttribute('value') || e.target.value;
  if (val === 'overview') {
    window.location.href = '/dashboard';
  }
});

// Check read-only access
async function checkAccess() {
  try {
    const res = await fetch(API + '/routing', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    if (res.status === 403) {
      isReadonly = true;
      document.getElementById('readonlyNotice').style.display = 'block';
    }
  } catch {}
}

checkAccess().then(loadRules);
</script>
</body>
</html>
